{% extends "base.html" %}

{% block content %}
<style>
    /* Keep specific time picker styles, adjust colors */
    .time-picker-container {
        display: flex;
        align-items: center;
        gap: 0.5rem; /* space-x-2 */
    }
    
    .time-picker-select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        /* Use Tailwind colors */
        background-color: #f9fafb; /* gray-50 */
        border: 1px solid #d1d5db; /* border-gray-300 */
        border-radius: 0.375rem; /* rounded-md */
        /* Reduce vertical padding slightly */
        padding: 0.375rem 0.5rem; /* py-1.5 px-2 */
        text-align: center;
        cursor: pointer;
        max-height: 38px; /* Custom */
        overflow-y: auto;
        scrollbar-width: thin;
        color: #374151; /* text-gray-700 */
        font-weight: 500; /* font-medium */
        font-size: 0.875rem; /* text-sm */
    }
     .dark .time-picker-select {
        background-color: #3f3f46; /* dark:bg-zinc-700 */
        border-color: #52525b; /* dark:border-zinc-600 */
        color: #d1d5db; /* dark:text-gray-300 */
     }
    
    .time-picker-select::-webkit-scrollbar {
        width: 6px;
    }
    
    .time-picker-select::-webkit-scrollbar-thumb {
        background-color: #a1a1aa; /* zinc-400 */
        border-radius: 3px;
    }
    
    .time-picker-select:focus {
        /* Use brand color for focus ring */
        border-color: #10b981; /* focus:border-brand-500 */
        outline: 0;
        box-shadow: 0 0 0 3px rgba(167, 243, 208, 0.5); /* focus:ring-brand-200 focus:ring-opacity-50 */
    }
    
    .time-picker-label {
        font-weight: 600; /* font-semibold */
        margin-bottom: 0;
        text-align: center;
        color: #374151; /* text-gray-700 */
        font-size: 0.75rem; /* text-xs */
    }
    .dark .time-picker-label {
        color: #a1a1aa; /* dark:text-zinc-400 */
    }

    .time-item {
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: 0.5rem; /* p-2 */
        border: 1px solid #e5e7eb; /* border-gray-200 */
        border-radius: 0.375rem; /* rounded-md */
        margin-bottom: 0.5rem; /* mb-2 */
        /* Handled by JS now */
        /* background-color: #fff; */ 
    }
    .dark .time-item {
         border-color: #52525b; /* dark:border-zinc-600 */
         /* background-color: #3f3f46; */ /* Handled by JS */
    }

    .time-separator {
        color: #374151; /* text-gray-700 */
        font-weight: bold;
        font-size: 1rem; /* text-base */
    }
     .dark .time-separator {
        color: #a1a1aa; /* dark:text-zinc-400 */
     }

    .timezone-label {
        font-size: 0.875rem; /* text-sm */
        color: #6b7280; /* text-gray-500 */
        margin-left: 0.75rem; /* ml-3 */
    }
    .dark .timezone-label {
        color: #9ca3af; /* dark:text-zinc-400 */
    }

</style>

{# Centered container using Tailwind #}
<div class="max-w-3xl mx-auto">
    {# Main card/panel styling - Use zinc dark bg #}
    <div class="bg-white dark:bg-zinc-800 shadow-md rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-zinc-700">
            <h4 class="text-xl font-semibold text-gray-900 dark:text-white">Booking Preferences</h4>
        </div>
        <div class="px-6 py-6">
            <form method="POST" class="space-y-6">
                {# Preferred Court - Use zinc dark bg/border, brand focus #}
                <div>
                    <label for="court_name" class="block text-sm font-medium text-gray-700 dark:text-zinc-300">Preferred Court</label>
                    <select name="court_name" id="court_name" required
                            class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white dark:bg-zinc-700 dark:border-zinc-600 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-brand-500 focus:border-brand-500 sm:text-sm">
                        <option value="">Select a court</option>
                        {% for court in courts %}
                        <option value="{{ court.name }}" {% if preferences and preferences.court_name == court.name %}selected{% endif %}>{{ court.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                {# Preferred Days - Use brand color for checkbox, zinc dark #}
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-zinc-300">Preferred Days</label>
                    {% set preferred_days = preferences.preferred_days if preferences else [] %}
                    <div class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-4">
                        {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                        <div class="flex items-center">
                            <input type="checkbox" name="preferred_days" value="{{ day }}" id="{{ day|lower }}" 
                                   {% if day in preferred_days %}checked{% endif %}
                                   class="h-4 w-4 text-brand-600 border-gray-300 rounded focus:ring-brand-500 dark:bg-zinc-700 dark:border-zinc-600 dark:focus:ring-brand-600 dark:focus:ring-offset-zinc-800">
                            <label for="{{ day|lower }}" class="ml-2 block text-sm text-gray-900 dark:text-zinc-300">{{ day }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                {# Preferred Times Section - Use zinc dark border/bg, brand button/focus #}
                <div class="border border-gray-200 dark:border-zinc-700 rounded-md">
                    <div class="bg-gray-50 dark:bg-zinc-700 px-4 py-3 border-b border-gray-200 dark:border-zinc-600 flex justify-between items-center rounded-t-md">
                        <span class="text-lg font-medium text-gray-900 dark:text-white">Preferred Time Slots</span>
                        <button type="button" id="add-time" 
                                class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded shadow-sm text-white bg-brand-600 hover:bg-brand-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 dark:focus:ring-offset-zinc-800">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Time Slot
                        </button>
                    </div>
                    <div class="p-4">
                        {# Container for dynamically added time slots #}
                        <div id="time-selections-container" class="space-y-2 mb-4">
                            {# Time selections will be added here dynamically using JS #}
                        </div>
                        
                        {# Hidden input stores comma-separated times #}
                        <input type="hidden" id="all-preferred-times" name="preferred_times" value="{{ preferred_times|join(',') if preferred_times else '' }}">
                        
                        {# Info Alert - Use zinc dark bg #}
                        <div class="mt-3 p-3 text-sm text-blue-700 bg-blue-100 rounded-lg dark:bg-zinc-700 dark:text-blue-300" role="alert">
                            Add up to 3 specific time slots (HH:MM format) when you prefer to play. The system will try these times first.
                        </div>
                    </div>
                </div>

                {# Preferred Playtime Duration Section - Use zinc dark border/bg, brand selected state #}
                <div class="border border-gray-200 dark:border-zinc-700 rounded-md">
                     <div class="bg-gray-50 dark:bg-zinc-700 px-4 py-3 border-b border-gray-200 dark:border-zinc-600 rounded-t-md">
                        <span class="text-lg font-medium text-gray-900 dark:text-white">Preferred Playtime Duration</span>
                    </div>
                    <div class="p-4">
                         {# Use Tailwind grid and utility classes for playtime options #}
                        <div class="playtime-options-container grid grid-cols-2 gap-4"> {# Added a unique class #}
                            {% set current_duration = preferences.playtime_duration if preferences else 60 %}
                            {% for duration in [60, 90] %}
                            <div data-duration="{{ duration }}"
                                 class="playtime-option group cursor-pointer rounded-md border p-4 text-center transition duration-150 ease-in-out 
                                        {% if current_duration == duration %}
                                            bg-brand-600 border-brand-600 text-white
                                        {% else %}
                                            border-gray-300 dark:border-zinc-600 text-gray-900 dark:text-zinc-200 
                                            hover:border-brand-400 hover:bg-brand-50 dark:hover:border-brand-500 dark:hover:bg-zinc-700
                                        {% endif %}">
                                <span class="block text-2xl font-bold 
                                             {% if current_duration == duration %}text-white{% else %}text-brand-600 dark:text-brand-400 group-hover:text-brand-700 dark:group-hover:text-brand-300{% endif %}">
                                    {{ duration }}
                                </span>
                                <span class="block text-xs 
                                             {% if current_duration == duration %}text-brand-100{% else %}text-gray-500 dark:text-zinc-400 group-hover:text-gray-600 dark:group-hover:text-zinc-300{% endif %}">
                                    minutes
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        
                        {# Hidden input stores selected duration #}
                        <input type="hidden" id="playtime-duration" name="playtime_duration" value="{{ current_duration }}">
                        
                        {# Info Alert - Use zinc dark bg #}
                        <div class="mt-3 p-3 text-sm text-blue-700 bg-blue-100 rounded-lg dark:bg-zinc-700 dark:text-blue-300" role="alert">
                            Select your preferred playtime duration.
                        </div>
                    </div>
                </div>

                {# Account Info - Use zinc dark bg/border, brand focus #}
                <div class="space-y-4">
                    <div>
                        <label for="rec_account_email" class="block text-sm font-medium text-gray-700 dark:text-zinc-300">Rec & Park Account Email</label>
                        <input type="email" name="rec_account_email" id="rec_account_email" required 
                               placeholder="user@example.com" 
                               value="{{ preferences.rec_account_email if preferences else '' }}"
                               class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white dark:bg-zinc-700 dark:border-zinc-600 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-brand-500 focus:border-brand-500 sm:text-sm">
                    </div>

                    <div>
                        <label for="rec_account_password" class="block text-sm font-medium text-gray-700 dark:text-zinc-300">Rec & Park Account Password</label>
                        <input type="password" name="rec_account_password" id="rec_account_password" required 
                               placeholder="Enter your password" 
                               class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white dark:bg-zinc-700 dark:border-zinc-600 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-brand-500 focus:border-brand-500 sm:text-sm">
                         <p class="mt-1 text-xs text-gray-500 dark:text-zinc-400">Your password is stored securely and only used for booking.</p>
                    </div>

                    <div>
                        <label for="phone_number" class="block text-sm font-medium text-gray-700 dark:text-zinc-300">Phone Number</label>
                        <input type="tel" name="phone_number" id="phone_number" required 
                               placeholder="1234567890" 
                               value="{{ preferences.phone_number if preferences else '' }}"
                               class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white dark:bg-zinc-700 dark:border-zinc-600 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-brand-500 focus:border-brand-500 sm:text-sm">
                        <p class="mt-1 text-xs text-gray-500 dark:text-zinc-400">Used for booking verification if needed (10 digits, no spaces/hyphens).</p>
                    </div>
                </div>

                {# Submit Button - Use arbitrary value for specific green #}
                <div>
                    <button type="submit" 
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#006239] hover:bg-[#00522f] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-500 dark:focus:ring-offset-zinc-800">
                        Save Preferences
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const timeSelectionsContainer = document.getElementById('time-selections-container');
        const addTimeBtn = document.getElementById('add-time');
        const allPreferredTimesInput = document.getElementById('all-preferred-times');
        const maxTimes = 3; // Max number of preferred times

        // --- Playtime Duration Logic --- 
        const playtimeOptionsContainer = document.querySelector('.playtime-options-container'); // Use specific class
        const playtimeDurationInput = document.getElementById('playtime-duration');

        // Define classes using BRAND color (emerald)
        const selectedClasses = ['bg-brand-600', 'border-brand-600', 'text-white'];
        const unselectedClasses = ['border-gray-300', 'dark:border-zinc-600', 'text-gray-900', 'dark:text-zinc-200', 'hover:border-brand-400', 'hover:bg-brand-50', 'dark:hover:border-brand-500', 'dark:hover:bg-zinc-700'];
        const selectedTextClasses = ['text-white'];
        const unselectedTextClasses = ['text-brand-600', 'dark:text-brand-400', 'group-hover:text-brand-700', 'dark:group-hover:text-brand-300'];
        const selectedSubTextClasses = ['text-brand-100'];
        const unselectedSubTextClasses = ['text-gray-500', 'dark:text-zinc-400', 'group-hover:text-gray-600', 'dark:group-hover:text-zinc-300'];

        if (playtimeOptionsContainer) {
            playtimeOptionsContainer.addEventListener('click', function(e) {
                const targetOption = e.target.closest('.playtime-option');
                if (!targetOption) return; // Clicked outside an option

                const selectedDuration = targetOption.getAttribute('data-duration');
                playtimeDurationInput.value = selectedDuration;

                // Update styles for all options
                playtimeOptionsContainer.querySelectorAll('.playtime-option').forEach(option => {
                    const duration = option.getAttribute('data-duration');
                    const durationSpan = option.querySelector('span:first-child');
                    const unitSpan = option.querySelector('span:last-child');

                    option.classList.remove(...selectedClasses, ...unselectedClasses);
                    if (durationSpan) durationSpan.classList.remove(...selectedTextClasses, ...unselectedTextClasses);
                    if (unitSpan) unitSpan.classList.remove(...selectedSubTextClasses, ...unselectedSubTextClasses);

                    if (duration === selectedDuration) {
                        option.classList.add(...selectedClasses);
                        if (durationSpan) durationSpan.classList.add(...selectedTextClasses);
                        if (unitSpan) unitSpan.classList.add(...selectedSubTextClasses);
                    } else {
                        option.classList.add(...unselectedClasses);
                         if (durationSpan) durationSpan.classList.add(...unselectedTextClasses);
                         if (unitSpan) unitSpan.classList.add(...unselectedSubTextClasses);
                    }
                });
            });
        }
        // --- End Playtime Duration Logic ---

        // --- Preferred Times Logic (Adjusted Spacing again) --- 
        function updatePreferredTimesInput() {
            const times = [];
            timeSelectionsContainer.querySelectorAll('.time-item').forEach(item => {
                const hourSelect = item.querySelector('.time-picker-select[name="hour"]');
                const minuteSelect = item.querySelector('.time-picker-select[name="minute"]');
                const ampmSelect = item.querySelector('.time-picker-select[name="ampm"]'); // Get AM/PM select
                
                // Check all selects exist
                if (hourSelect && minuteSelect && ampmSelect) { 
                    let hour = parseInt(hourSelect.value, 10); // Hour is 1-12
                    const minute = minuteSelect.value; // Minute is 00 or 30
                    const ampm = ampmSelect.value;

                    // Convert to 24-hour format for storage
                    let hour24 = hour;
                    if (ampm === 'PM' && hour !== 12) hour24 += 12;
                    if (ampm === 'AM' && hour === 12) hour24 = 0; // Handle 12 AM (midnight)
                    
                    // Format as HH:MM
                    const formattedHour = String(hour24).padStart(2, '0');
                    const formattedTime = `${formattedHour}:${minute}`;
                    
                    if (/^\d{2}:\d{2}$/.test(formattedTime)) { 
                         times.push(formattedTime);
                    }
                }
            });
            allPreferredTimesInput.value = times.join(',');
            checkMaxTimes();
        }

        function checkMaxTimes() {
            const count = timeSelectionsContainer.querySelectorAll('.time-item').length;
            if (addTimeBtn) {
                 addTimeBtn.disabled = count >= maxTimes;
                 addTimeBtn.classList.toggle('opacity-50', count >= maxTimes);
                 addTimeBtn.classList.toggle('cursor-not-allowed', count >= maxTimes);
            }
        }

        function createTimeSelectionElement(initialTime = null) {
            const timeItem = document.createElement('div');
            timeItem.className = 'time-item flex items-center justify-between p-2 border border-gray-200 dark:border-zinc-600 rounded-md mb-2 bg-white dark:bg-zinc-700'; 

            const pickerContainer = document.createElement('div');
            pickerContainer.className = 'time-picker-container flex items-center'; 

            // Hour Select (1-12)
            const hourSelect = document.createElement('select');
            hourSelect.name = 'hour';
            hourSelect.className = 'time-picker-select'; // No margin
            for (let i = 1; i <= 12; i++) {
                const val = String(i).padStart(2, '0');
                const option = new Option(val, val);
                hourSelect.add(option);
            }

            // Separator
            const separator = document.createElement('span');
            // Remove margin (mx-1) from separator
            separator.className = 'time-separator font-bold text-gray-700 dark:text-zinc-400'; 
            separator.textContent = ':';

            // Minute Select (00, 30)
            const minuteSelect = document.createElement('select');
            minuteSelect.name = 'minute';
            minuteSelect.className = 'time-picker-select'; // No margin
            ['00', '30'].forEach(val => {
                minuteSelect.add(new Option(val, val));
            });

            // AM/PM Select
            const ampmSelect = document.createElement('select');
            ampmSelect.name = 'ampm';
            // Keep left margin to separate AM/PM from minutes
            ampmSelect.className = 'time-picker-select ml-2'; 
            ['AM', 'PM'].forEach(val => {
                 ampmSelect.add(new Option(val, val));
            });
            
            // Timezone Label
            const timezoneLabel = document.createElement('span');
            timezoneLabel.className = 'timezone-label text-sm text-gray-500 dark:text-zinc-400 ml-3';
            timezoneLabel.textContent = 'PST/PDT';

            // Set initial values (logic remains the same)
            if (initialTime && /^\d{2}:\d{2}$/.test(initialTime)) {
                const [initialHour24, initialMinute] = initialTime.split(':');
                const hour24 = parseInt(initialHour24, 10);
                const isPM = hour24 >= 12;
                let displayHour = hour24 % 12;
                if (displayHour === 0) displayHour = 12;
                hourSelect.value = String(displayHour).padStart(2, '0');
                minuteSelect.value = initialMinute;
                ampmSelect.value = isPM ? 'PM' : 'AM';
            } else {
                hourSelect.value = '09';
                minuteSelect.value = '00';
                ampmSelect.value = 'AM';
            }

            // Append elements in the desired order
            pickerContainer.appendChild(hourSelect);
            pickerContainer.appendChild(separator);
            pickerContainer.appendChild(minuteSelect);
            pickerContainer.appendChild(ampmSelect);
            
            // Container for picker + timezone label (remains the same)
            const timeDisplayContainer = document.createElement('div');
            timeDisplayContainer.className = 'flex items-center';
            timeDisplayContainer.appendChild(pickerContainer);
            timeDisplayContainer.appendChild(timezoneLabel);

            // Remove Button (remains the same)
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-time ml-4 inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 dark:bg-zinc-600 dark:text-red-400 dark:hover:bg-zinc-500 dark:focus:ring-offset-zinc-800 dark:focus:ring-red-500';
            removeBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                 </svg>`; 
            removeBtn.onclick = function() {
                timeItem.remove();
                updatePreferredTimesInput();
            };

            timeItem.appendChild(timeDisplayContainer);
            timeItem.appendChild(removeBtn);

            // Add change listeners (remains the same)
            hourSelect.addEventListener('change', updatePreferredTimesInput);
            minuteSelect.addEventListener('change', updatePreferredTimesInput);
            ampmSelect.addEventListener('change', updatePreferredTimesInput);

            return timeItem;
        }

        // Initial setup: Load existing times
        const existingTimesRaw = allPreferredTimesInput.value;
        const existingTimes = existingTimesRaw ? existingTimesRaw.split(',') : [];
        if (timeSelectionsContainer) {
             existingTimes.forEach(time => {
                if (time.trim() && /^\d{2}:\d{2}$/.test(time.trim())) { 
                    const timeElement = createTimeSelectionElement(time.trim());
                    timeSelectionsContainer.appendChild(timeElement);
                }
            });
            if (timeSelectionsContainer.children.length === 0) {
                 const defaultTimeElement = createTimeSelectionElement();
                 timeSelectionsContainer.appendChild(defaultTimeElement);
                 updatePreferredTimesInput();
            }
            checkMaxTimes(); 
        }
        if (addTimeBtn && timeSelectionsContainer) {
             addTimeBtn.addEventListener('click', function() {
                if (timeSelectionsContainer.querySelectorAll('.time-item').length < maxTimes) {
                    const newTimeElement = createTimeSelectionElement(); 
                    timeSelectionsContainer.appendChild(newTimeElement);
                    updatePreferredTimesInput(); 
                } 
            });
        }
        // --- End Preferred Times Logic ---

    });
</script>
{% endblock %}